<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>REFLECTIONS</title>
    <link rel="stylesheet" href="style.css">
    
    <script>
        window.onerror = function(msg, url, line) {
            const box = document.getElementById('error-box');
            if(box) {
                box.style.display = 'block';
                box.innerHTML += `CRITICAL ERROR:<br>${msg}<br>File: ${url.split('/').pop()}<br>Line: ${line}<br>----------------<br>`;
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#400; color:#fff; z-index:99999; padding:20px; font-family:monospace; font-size:1.2rem; overflow:auto;">
        SYSTEM FAILURE DETECTED.<br>
        ------------------------<br>
    </div>

    <video id="webcamVideo" class="input_video" playsinline style="display:none;"></video>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="start-screen" class="screen active">
            <div class="consent-box" style="width: 550px;">
                <h1>REFLECTIONS</h1>
                <div id="loading-phase">
                    <canvas id="miniGameCanvas" width="500" height="150"></canvas>
                    <p style="font-size:0.8rem; color:#666; margin: 10px 0;">(Play Pong while AI modules download...)</p>
                    <div id="loading-container">
                        <div id="progress-bar-bg"><div id="progress-bar-fill"></div></div>
                        <div id="system-log">System Boot...</div>
                    </div>
                </div>
                <div id="calibration-phase" style="display:none;">
                    <div class="monitor-frame">
                        <p style="color:#00ff88; margin:0; padding:5px; background:#002200; font-size:0.8rem;">BIOMETRIC CALIBRATION MODE</p>
                        <canvas id="calibrationCanvas" width="480" height="360"></canvas>
                    </div>
                    <p style="color:#ccc; font-size:0.9rem; margin-top:10px;">Check lighting. Show HAND and FACE.</p>
                </div>
                <button id="btn-start" disabled>INITIALIZING AI...</button>
            </div>
        </div>

        <div id="end-screen" class="screen">
            <div class="consent-box" style="width: 800px; max-height: 90vh; overflow-y: auto;">
                <h1 style="color:#00ff88;">SURVIVAL REPORT</h1>
                <div id="reaction-reel" style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin: 20px 0;"></div>
                <button onclick="location.reload()" style="border-color:#fff; color:#fff;">PLAY AGAIN</button>
            </div>
        </div>

        <div id="hud">
            <div id="center-reticle"></div>
            <div id="interaction-prompt"></div>
            <div id="battery-container">
                <div id="battery-icon">ðŸ”‹</div>
                <div id="battery-bar-wrap"><div id="battery-fill"></div></div>
            </div>
            <div id="camera-status">ðŸ”´ REC</div>
            <div id="ai-icons" style="position:absolute; bottom:20px; right:20px; display:none;">
                <div id="hand-icon">âœ‹</div>
                <div id="face-icon">ðŸ˜€</div>
            </div>
            <button id="btn-panic">PANIC STOP</button>
        </div>
    </div>

    <script>
        (function() {
            const cvs = document.getElementById('miniGameCanvas');
            const ctx = cvs.getContext('2d');
            let ball = { x: 250, y: 75, dx: 4, dy: 4, size: 6 };
            let paddle = { x: 225, w: 60, h: 8 };
            let active = true;
            cvs.addEventListener('mousemove', (e) => {
                const rect = cvs.getBoundingClientRect();
                paddle.x = e.clientX - rect.left - paddle.w/2;
            });
            function gameLoop() {
                if(!active) return;
                requestAnimationFrame(gameLoop);
                ctx.fillStyle = '#050505'; ctx.fillRect(0,0, cvs.width, cvs.height);
                ctx.strokeStyle = '#222'; ctx.strokeRect(0,0, cvs.width, cvs.height);
                ctx.fillStyle = '#00ff88'; ctx.fillRect(paddle.x, 140, paddle.w, paddle.h);
                ball.x += ball.dx; ball.y += ball.dy;
                if(ball.x < 0 || ball.x > cvs.width) ball.dx *= -1;
                if(ball.y < 0) ball.dy *= -1;
                if(ball.y > 135 && ball.x > paddle.x && ball.x < paddle.x + paddle.w) { ball.dy *= -1; ball.dx *= 1.05; ball.dy *= 1.05; }
                if(ball.y > 160) ball = { x: 250, y: 75, dx: 4, dy: 4, size: 6 };
                ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI*2); ctx.fill();
            }
            gameLoop();
            window.stopPong = () => { active = false; };
        })();
    </script>
    <script type="module" src="game.js"></script>
</body>
</html>
